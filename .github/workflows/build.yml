name: strongR-frida

on:
  schedule:
    - cron: "0 9/12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_version:
    runs-on: ubuntu-22.04
    outputs:
      FRIDA_VERSION: ${{ steps.pullFridaLatestRelease.outputs.FRIDA_VERSION }}
      ALREADY_RELEASE: ${{ steps.checkReleaseVersion.outputs.ALREADY_RELEASE }}
    steps:
      - name: Pull Frida Latest Release
        id: pullFridaLatestRelease
        uses: actions/github-script@v7
        with:
          script: |
            const releaseResponse = await github.rest.repos.getLatestRelease({
              owner: 'frida',
              repo: 'frida',
            });
            const ver = releaseResponse.data.tag_name;
            core.setOutput('FRIDA_VERSION', ver);

      - name: Check release version
        id: checkReleaseVersion
        uses: actions/github-script@v7
        with:
          script: |
            const fridaVersion = '${{ steps.pullFridaLatestRelease.outputs.FRIDA_VERSION }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              const releaseResponse = await github.rest.repos.getReleaseByTag({
                owner: owner,
                repo: repo,
                tag: fridaVersion
              });
              // 릴리즈가 이미 존재함
              core.setOutput('ALREADY_RELEASE', '1');
            } catch (e) {
              if (e.status === 404) {
                // 릴리즈가 없음 (빌드 진행)
                core.setOutput('ALREADY_RELEASE', '0');
              } else {
                core.setFailed(e.message);
              }
            }

  android_build:
    runs-on: ubuntu-22.04
    needs: check_version
    if: needs.check_version.outputs.ALREADY_RELEASE == '0'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: install dependencies
        run: |
          sudo apt-get update && DEBIAN_FRONTEND=noninteractive sudo apt-get install build-essential tree ninja-build gcc-multilib g++-multilib lib32stdc++-9-dev flex bison ruby ruby-dev python3-requests python3-setuptools python3-dev python3-pip libc6-dev libc6-dev-i386 -y
          sudo gem install fpm -v 1.11.0 --no-document
          python3 -m pip install lief graphlib

      - name: build frida for Android
        shell: bash
        run: |
          # Git 설정 (빌드용 더미 설정)
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # 환경 변수 설정
          export ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}
          
          # Frida 원본 클론
          git clone --recurse-submodules https://github.com/frida/frida
          
          cd frida
          
          # 패치 적용 (현재 레포지토리의 Patchs 폴더 사용)
          # 체크아웃한 위치가 workspace 루트이므로 ../Patchs로 접근
          for path in ../Patchs/strongR-frida/*
          do
            name=$(basename $path)
            real=$(realpath $path)
            echo "Apply patches in $real to frida/subprojects/$name"
            
            # 해당 서브 프로젝트가 존재하는지 확인
            if [ -d "subprojects/$name" ]; then
                cd subprojects/$name
                git am ../../../Patchs/strongR-frida/$name/*.patch
                cd ../..
            else
                echo "Skipping $name (directory not found)"
            fi
          done
          
          # 아키텍처별 빌드
          ARCHES="android-arm android-arm64 android-x86 android-x86_64"
          for ARCH in $ARCHES
          do
            echo "Building for $ARCH..."
            mkdir -p build-$ARCH
            cd build-$ARCH
            ../frida/configure --host=$ARCH
            make
            cd ..
          done

      - name: package build result
        run: |
          # 파일 압축 (xz 사용 권장하지만 기존 호환성을 위해 gzip 사용하거나 그대로 둠)
          # 여기서는 원본 스크립트처럼 gzip 사용
          
          for ARCH in android-arm android-arm64 android-x86 android-x86_64
          do
            # Server
            if [ -f "build-$ARCH/subprojects/frida-core/server/frida-server" ]; then
              gzip -c "build-$ARCH/subprojects/frida-core/server/frida-server" > "hluda-server-${{ needs.check_version.outputs.FRIDA_VERSION }}-$ARCH.gz"
            fi
            
            # Inject
            if [ -f "build-$ARCH/subprojects/frida-core/inject/frida-inject" ]; then
              gzip -c "build-$ARCH/subprojects/frida-core/inject/frida-inject" > "hluda-inject-${{ needs.check_version.outputs.FRIDA_VERSION }}-$ARCH.gz"
            fi
            
            # Gadget
            if [ -f "build-$ARCH/subprojects/frida-core/lib/gadget/frida-gadget.so" ]; then
              gzip -c "build-$ARCH/subprojects/frida-core/lib/gadget/frida-gadget.so" > "hluda-gadget-${{ needs.check_version.outputs.FRIDA_VERSION }}-$ARCH.so.gz"
            fi
          done

      - name: Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          files: |
            hluda-server-*.gz
            hluda-inject-*.gz
            hluda-gadget-*.so.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

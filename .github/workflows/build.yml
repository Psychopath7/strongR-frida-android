name: strongR-frida-Fixed

on:
  workflow_dispatch: # 수동 실행 전용

permissions:
  contents: write

jobs:
  android_build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential tree ninja-build gcc-multilib g++-multilib lib32stdc++-9-dev flex bison ruby ruby-dev python3-requests python3-setuptools python3-dev python3-pip libc6-dev libc6-dev-i386
          sudo gem install fpm -v 1.11.0 --no-document
          python3 -m pip install lief graphlib

      - name: build frida for Android
        shell: bash
        run: |
          # -------------------------------------------
          # 여기서 버전을 고정합니다 (17.5.2는 검증된 버전)
          FIXED_FRIDA_VERSION="17.5.2"
          # -------------------------------------------
          
          echo "Building Locked Version: $FIXED_FRIDA_VERSION"
          
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          export ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}
          
          # 최신이 아닌 특정 태그(버전)를 클론
          git clone --recurse-submodules --branch $FIXED_FRIDA_VERSION https://github.com/frida/frida
          
          cd frida
          
          # 패치 적용
          for path in ../Patchs/strongR-frida/*
          do
            name=$(basename $path)
            if [ -d "subprojects/$name" ]; then
                echo "Applying patch: $name"
                cd subprojects/$name
                # 패치 오류 시 강제 진행을 막기 위해 체크
                git am ../../../Patchs/strongR-frida/$name/*.patch || { echo "Patch failed! Check version compatibility."; exit 1; }
                cd ../..
            fi
          done
          
          # 빌드 (시간 절약을 위해 arm64만)
          # 필요하면 아래 줄에 android-arm android-x86 등을 추가하세요
          ARCHES="android-arm64"
          
          for ARCH in $ARCHES
          do
            echo "Building for $ARCH..."
            mkdir -p build-$ARCH
            cd build-$ARCH
            ../frida/configure --host=$ARCH
            make
            cd ..
          done

      - name: package build result
        run: |
          FIXED_FRIDA_VERSION="17.5.2"
          ARCHES="android-arm64"
          
          for ARCH in $ARCHES
          do
            if [ -f "build-$ARCH/subprojects/frida-core/server/frida-server" ]; then
              echo "Packaging $ARCH..."
              gzip -c "build-$ARCH/subprojects/frida-core/server/frida-server" > "hluda-server-$FIXED_FRIDA_VERSION-$ARCH.gz"
            else
              echo "Error: Output file not found for $ARCH"
            fi
          done

      - name: Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "17.5.2-custom"
          name: "StrongR-Frida 17.5.2 (Custom Build)"
          draft: false
          prerelease: false
          files: |
            hluda-*.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
